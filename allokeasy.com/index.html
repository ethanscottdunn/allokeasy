<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Allokeasy</title>
  <link rel="icon" type="image/x-icon" href="allokeasy_favicon.ico">
  <link rel="stylesheet" href="static/styles.css">
</head>
<body>
<div class="container">
<div class="card">
	<h1>Allokeasy</h1>
	<p>Optimize your portfolio allocation with tax considerations.</p>
	<p><a href="instructions.html">How to use this website</a></p>
  <p><a href="interpret_results.html">How to interpret the results</a></p>
</div>
  <div id="loading" style="display:none;">
    <p>Processing, please wait... <span class="spinner"></span></p>
  </div>
<div class="card">
  <h2>Portfolio optimization calculation inputs</h2>
  <form id="uploadForm">
    <label>Portfolio export (.csv file like "cost_basis_vanguard.csv"): <input type="file" name="csvfile" required></label><br><br>
    <label>Annual Income (for determining tax bracket for realized gains): <input type="number" step="any" name="income" required></label><br><br>
    <label>Tax Filing Status:
      <select name="status" required>
        <option value="single">Single</option>
        <option value="married_joint">Married Filing Jointly</option>
        <option value="married_separate">Married Filing Separately</option>
      </select>
    </label><br><br>
    <label>Risk Free Rate (currently 4%): <input type="number" step="any" name="risk_free_rate" value=".04" required></label><br><br>
    <p>Calculate based on this historical period (default: past 5 years)</p>
    <label>Start Date: <input type="date" name="start_date" id="start_date" required></label><br><br>
    <label>End Date: <input type="date" name="end_date" id="end_date" required></label><br><br>
    <button type="submit">Submit</button>
  </form>
</div>
<div clas="card" id="graphs"></div>
<div class="card" id="resultsContainer">
  <div class="results" id="results"></div>
</div>
</div>
  <script>
    // Date for the default End Date
const today = new Date();
const fiveYearsAgo = new Date();
fiveYearsAgo.setFullYear(today.getFullYear() - 5);

document.getElementById('start_date').value = fiveYearsAgo.toISOString().split('T')[0];
document.getElementById('end_date').value = today.toISOString().split('T')[0];
    
    // Process Form Data
 // Handle Portfolio Submit 
function formatValue(val, isPercent = false) {
  if (typeof val === "number") {
    return isPercent ? (val * 100).toFixed(2) + "%" : val.toFixed(2);
  } else if (typeof val === "object" && val !== null) {
    // dictionary with pre_tax and post_tax
    const pre = isPercent ? (val.pre_tax * 100).toFixed(2) + "%" : val.pre_tax.toFixed(2);
    const post = isPercent ? (val.post_tax * 100).toFixed(2) + "%" : val.post_tax.toFixed(2);
    return `<span style="color: red;">Pre-tax: ${pre}</span><br><span style="color: orange;">Post-tax: ${post}</span>`;
  }
  return "N/A";
}

function createCard(title, obj, color) {
  const card = document.createElement("div");
  card.className = "card";

  // Apply header color only if color is provided (not null)
  const headerStyle = color ? `style="color: ${color}; border-bottom: 3px solid ${color}; padding-bottom: 0.5rem;"` : 'style="padding-bottom: 0.5rem;"';

  card.innerHTML = `
    <h2 ${headerStyle}>${title}</h2>
    <div class="stats">
      <div class="stat-label">Portfolio Value:</div>
      <div class="stat-value">$${obj.value.toLocaleString()}</div>

      <div class="stat-label">Return:</div>
      <div class="stat-value">${formatValue(obj.ret, true)}</div>

      <div class="stat-label">Std Dev:</div>
      <div class="stat-value">${formatValue(obj.std, true)}</div>

      <div class="stat-label"><mark>Sharpe:</mark></div>
      <div class="stat-value"><mark>${formatValue(obj.sharpe, false)}</mark></div>

      <div class="stat-label">Taxes Paid:</div>
      <div class="stat-value">$${obj.taxes_paid.toLocaleString()}</div>
    </div>
    <table>
      <thead>
        <tr><th>Ticker</th><th>Allocation</th></tr>
      </thead>
      <tbody>
        ${obj.portfolio.map(([ticker, value]) => `
          <tr>
            <td>${ticker}</td>
            <td style="text-align:right">${value.toFixed(2)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  return card;
}

document.getElementById("uploadForm").addEventListener("submit", async function(e) {
    e.preventDefault();
        // Show the spinner
    document.getElementById("loading").style.display = "block";

    const form = e.target;
    const formData = new FormData(form);

    const response = await fetch("cgi-bin/process.py", {
        method: "POST",
        body: formData,
    });

    if (response.ok) {
        const data = await response.json();

        document.getElementById("resultsContainer").style.display = "block";

        // Clear previous graphs
        const graphContainer = document.getElementById("graphs");
        graphContainer.innerHTML = ""; // clear old graphs

        // --- Create a card with the image ---
        const imgCard = document.createElement("div");
        imgCard.classList.add("card"); // optional, if you want same styling
        // Add timestamp to prevent caching
        const timestamp = new Date().getTime();
        imgCard.innerHTML = `<img src="returns_comparison_plot.svg?t=${timestamp}" alt="Plot" style="max-width:100%;">`;
        graphContainer.appendChild(imgCard);

        const container = document.getElementById("results");
        container.innerHTML = ""; // clear old results

        container.appendChild(createCard("What you have now", data.original, "blue"));
        container.appendChild(createCard("If you optimized ignoring taxes", data.optimized, "orange"));
        container.appendChild(createCard("If you optimized considering taxes", data.tax_optimized, "green"));
    } else {
        document.getElementById("results").innerHTML = "<p style='color:red'>Error submitting form.</p>";
    }
   document.getElementById("loading").style.display = "none";
});


  </script>
</body>
</html>
