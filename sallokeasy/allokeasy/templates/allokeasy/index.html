<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Allokeasy: Reallocation suggestions for your portfolio, including minimizing taxes accrued by rebalancing.</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 2rem;
    }
    .container {
      max-width: 900px;
      margin: auto;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
    .card {
      background: white;
      padding: 1.5rem;
      border: 1px solid #ddd;
      border-radius: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.25rem;
    }
    input[type="file"], input[type="text"] {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
    }
    .grid {
      display: grid;
      gap: 0.75rem;
    }
    .grid-2 {
      grid-template-columns: 1fr 1fr 1fr;
    }
    button {
      background: #2563eb;
      color: white;
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      margin-top: 1rem;
    }
    button:hover {
      background: #1d4ed8;
    }
    ul {
      padding-left: 1.25rem;
    }
    .boxes {
      display: grid;
      gap: 1rem;
    }
    @media (min-width: 768px) {
      .boxes {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    .box {
      text-align: center;
      padding: 2rem;
      border: 1px solid #ddd;
      border-radius: 1rem;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .stats p {
      margin: 4px 0;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 10px;
    }

    table th, table td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    table th {
      background: #f3f4f6;
      text-align: left;
    }    

    #resultsContainer {
    display: grid;
    gap: 1rem;
    margin-top: 1rem;
    align-items: stretch; /* makes cards equal height */
    }

    @media (min-width: 768px) {
      #resultsContainer {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    #resultsContainer .card {
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- 1. CSV Upload -->
    <!-- <div class="card">
      <h2>Upload Investment CSV</h2>
      <input type="file" id="csvFile" accept=".csv">
      <button id="csvSubmit">Submit CSV</button>
      <p id="csvStatus" style="margin-top:0.5rem;color:green;"></p>
    </div> -->

 <!-- 1. CSV Upload + User Info Section -->
    <div class="card">
      <h2>Upload CSV with Current Portfolio Allocation</h2>

      <!-- CSV Upload -->
      <h3>CSV Upload</h3>
      <input type="file" id="csvFile" accept=".csv">
      <button id="csvSubmit">Submit CSV</button> 
      <p id="csvStatus" style="margin-top:0.5rem;color:green;"></p>
    </div>


    <!-- 3. Allocations Table -->
    <div class="card">
      <h2>Current Allocations</h2>
      <div class="grid grid-2">
        <div><strong>Name</strong></div>
        <div><strong>Quantity</strong></div>
        <div><strong>Market Value</strong></div>
        <div>Name</div><div>Quantity</div><div>Market Value</div>
      </div>
    </div>
    
    <!-- <div class="card">
      <h2> Portfolio Calculation Inputs </h2>
      <h3>User Information</h3>
      <div class="grid">
        <div>
          <label for="income">User income $:</label>
          <input type="number" id="income" placeholder="Enter income">
        </div>
        <div>
          <label for="filingStatus">User filing status:</label>
          <select id="filingStatus">
            <option value="">-- Select --</option>
            <option value="single">Single</option>
            <option value="married_joint">Married filing jointly</option>
            <option value="married_separate">Married filing separately</option>
          </select>
        </div>
        <div>
          <label for="risk_free_rate">Risk free rate:</label>
          <input type="number" id="risk_free_rate" value="4">%          
        </div>
      </div>
    </div> -->
      <!-- <button id="userSubmit">Calculate Optimal Portfolio (Re)Allocations </button>
      <p id="userStatus" style="margin-top:0.5rem;color:green;"></p>-->
    
    <div class="card">
      <h2> Portfolio Calculation Inputs </h2>
   <form id="portfolioForm" method="POST" enctype="multipart/form-data" action="{% url 'produce_optimized_portfolio' %}">
    {% csrf_token %}

    <!-- CSV Upload -->
    <label for="csv_file">Upload CSV:</label>
    <input type="file" name="csv_file" id="csv_file" accept=".csv" required><br><br>

    <!-- Income -->
    <label for="income">Income:</label>
    <input type="number" step="any" name="income" id="income" required><br><br>

    <!-- Risk free rate -->
    <label for="risk_free_rate">Risk free rate:</label>
    <input type="number" step="any" name="risk_free_rate" id="risk_free_rate" value="4" required>%<br><br>

    <!-- Start Date -->
    <label for="start_date">Start Date:</label>
    <input type="date" name="start_date" id="start_date" value="2020-01-01" required><br><br>

    <!-- End Date -->
    <label for="end_date">End Date:</label>
    <input type="date" name="end_date" id="end_date" required><br><br>

    <!-- Dropdown -->
    <label for="filing_status">Filing Status:</label>
    <select name="filing_status" id="filing_status" required>
        <option value="single">Single</option>
        <option value="married_filing_separately">Married Filing Separately</option>
        <option value="married_filing_jointly">Married Filing Jointly</option>
    </select><br><br>

    <button type="submit" id="portfolioSubmit">Submit</button>
</form>
    </div>

  <div id="resultsContainer" class="container"></div>


  <script>

    // Date for the default End Date
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
    const day = String(today.getDate()).padStart(2, '0');

    const formattedDate = `${year}-${month}-${day}`;
    document.getElementById('end_date').value = formattedDate;

 // Handle Portfolio Submit 
function createCard(title, obj) {
  const card = document.createElement("div");
  card.className = "card";

  card.innerHTML = `
    <h2>${title}</h2>
    <div class="stats">
      <p><strong>Return:</strong> ${(obj.ret * 100).toFixed(2)}%</p>
      <p><strong>Std Dev:</strong> ${(obj.std * 100).toFixed(2)}%</p>
      <p><strong>Sharpe:</strong> ${obj.sharpe.toFixed(2)}</p>
      <p><strong>Taxes Paid:</strong> $${obj.taxes_paid.toLocaleString()}</p>
    </div>
    <table>
      <thead>
        <tr><th>Ticker</th><th>Allocation</th></tr>
      </thead>
      <tbody>
        ${obj.portfolio.map(([ticker, value]) => `
          <tr>
            <td>${ticker}</td>
            <td style="text-align:right">${value.toFixed(2)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  return card;
}

document.getElementById("portfolioForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    const response = await fetch(form.action, {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        }
    });

    if (response.ok) {
        const data = await response.json();

        const container = document.getElementById("resultsContainer");
        container.innerHTML = ""; // clear old results

        container.appendChild(createCard("Original", data.original));
        container.appendChild(createCard("Optimized", data.optimized));
        container.appendChild(createCard("Tax Optimized", data.tax_optimized));
    } else {
        document.getElementById("resultsContainer").innerHTML = "<p style='color:red'>Error submitting form.</p>";
    }
});
    
    // Handle CSV upload
    const csvSubmit = document.getElementById("csvSubmit");
    const csvFileInput = document.getElementById("csvFile");
    const csvStatus = document.getElementById("csvStatus");

    csvSubmit.addEventListener("click", async () => {
      const file = csvFileInput.files[0];
      if (!file) {
        alert("Please choose a CSV file first.");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      try {
        const response = await fetch("upload-csv/", {
          method: "POST",
          body: formData
        });

        if (response.ok) {
          const data = await response.json();
          csvStatus.textContent = "CSV uploaded successfully!";
          csvStatus.style.color = "green";

          // Display returned allocations in console (or inject into DOM)
          console.log("Parsed allocations:", data.allocations);

          // Example: replace allocations table dynamically
          const allocDiv = document.querySelector(".card:nth-of-type(2) .grid");
          allocDiv.innerHTML = "<div><strong>Name</strong></div><div><strong>Quantity</strong></div><div><strong>Market Value</strong></div>";
          data.allocations.forEach(row => {
              allocDiv.innerHTML += `<div>${row.ticker}</div><div>${row.quantity}</div><div>${row.market_value}</div>`;
          });
        } else {
          csvStatus.textContent = "Error uploading CSV.";
          csvStatus.style.color = "red";
        }
      } catch (err) {
        csvStatus.textContent = "Network error.";
        csvStatus.style.color = "red";
      }
    });


  </script>
</body>
</html>
